--- src/map/script.cpp	(revisão 65528)
+++ src/map/script.cpp	(cópia de trabalho)
@@ -9107,18 +9107,18 @@
  * return (npc)
  *	x : refine chance
  *	0 : false (max refine level or unequip..)
- * getequippercentrefinery(<equipment slot>{,<enriched>,<char_id>})
+ * getequippercentrefinery(<equipment slot>,<type>{,<char_id>})
  *------------------------------------------*/
 BUILDIN_FUNC(getequippercentrefinery)
 {
 	int i = -1,num;
-	bool enriched = false;
+	enum refine_cost_type cost_type = REFINE_COST_NORMAL;
 	TBL_PC *sd;
 
 	num = script_getnum(st,2);
-	if (script_hasdata(st, 3))
-		enriched = script_getnum(st, 3) != 0;
+	cost_type = (enum refine_cost_type)script_getnum(st, 3);
 
+
 	if (!script_charid2sd(4, sd)) {
 		script_pushint(st,0);
 		return SCRIPT_CMD_FAILURE;
@@ -9127,10 +9127,7 @@
 	if (equip_index_check(num))
 		i = pc_checkequip(sd,equip_bitmask[num]);
 	if (i >= 0 && sd->inventory.u.items_inventory[i].nameid && sd->inventory.u.items_inventory[i].refine < MAX_REFINE) {
-		enum refine_type type = REFINE_TYPE_SHADOW;
-		if (sd->inventory_data[i]->type != IT_SHADOWGEAR)
-			type = (enum refine_type)sd->inventory_data[i]->wlv;
-		script_pushint(st, status_get_refine_chance(type, (int)sd->inventory.u.items_inventory[i].refine, enriched));
+		script_pushint(st, status_get_refine_chance((enum refine_type)sd->inventory_data[i]->refine_type, (int)sd->inventory.u.items_inventory[i].refine, cost_type));
 	}
 	else
 		script_pushint(st,0);
@@ -24005,16 +24002,8 @@
 		return SCRIPT_CMD_SUCCESS;
 	}
 
-	int weapon_lv = sd->inventory_data[i]->wlv;
-	if (sd->inventory_data[i]->type == IT_SHADOWGEAR) {
-		if (sd->inventory_data[i]->equip == EQP_SHADOW_WEAPON)
-			weapon_lv = REFINE_TYPE_WEAPON4;
-		else
-			weapon_lv = REFINE_TYPE_SHADOW;
-	}
+	script_pushint(st, status_get_refine_cost((enum refine_type)sd->inventory_data[i]->refine_type, type, (enum refine_info_type)info));
 
-	script_pushint(st, status_get_refine_cost(weapon_lv, type, info != 0));
-
 	return SCRIPT_CMD_SUCCESS;
 }
 
@@ -24548,6 +24537,62 @@
 }
 
 /*
+* getblacksmithblessing(<type>,<refine>{,<var>})
+* Return info Blacksmith Blessing in (specified) an array
+* .@refinebb[0] = Blacksmith Blessing ID
+* .@refinebb[1] = Amount
+*/
+BUILDIN_FUNC(getblacksmithblessing) {
+	struct refine_bs_blessing bb;
+	int type = script_getnum(st, 2);
+	int refine = script_getnum(st, 3);
+	struct script_data *data = script_hasdata(st, 4) ? script_getdata(st, 4) : NULL;
+	char *name;
+
+	memset(&bb, 0, sizeof(struct refine_bs_blessing));
+	if (!status_get_refine_blacksmithBlessing(&bb, (enum refine_type)type, refine)) {
+		script_pushint(st, 0);
+		return SCRIPT_CMD_FAILURE;
+	}
+
+	if (data && data_isreference(data)) {
+		name = reference_getname(data);
+		setd_sub_num(st, NULL, name, 0, bb.nameid, data->ref);
+		setd_sub_num(st, NULL, name, 1, bb.count, data->ref);
+	}
+	else {
+		setd_sub_num(st, NULL, ".@refinebb", 0, bb.nameid, NULL);
+		setd_sub_num(st, NULL, ".@refinebb", 1, bb.count, NULL);
+	}
+	script_pushint(st, (bb.nameid) ? 1 : 0);
+	return SCRIPT_CMD_SUCCESS;
+}
+
+BUILDIN_FUNC(refineui){
+#if PACKETVER < 20161012
+	ShowError( "buildin_refineui: This command requires packet version 2016-10-12 or newer.\n" );
+	return SCRIPT_CMD_FAILURE;
+#else
+	struct map_session_data* sd;
+
+	if( !script_charid2sd(2,sd) ){
+		return SCRIPT_CMD_FAILURE;
+	}
+
+	if( !battle_config.feature_refineui ){
+		ShowError( "buildin_refineui: This command is disabled via configuration.\n" );
+		return SCRIPT_CMD_FAILURE;
+	}
+
+	if( !sd->state.refineui_open ){
+		clif_refineui_open(sd);
+	}
+
+	return SCRIPT_CMD_SUCCESS;
+#endif
+}
+
+/*
   convertpcinfo(<char_id>,<type>)
   convertpcinfo(<account_id>,<type>)
   convertpcinfo(<player_name>,<type>)
@@ -24775,7 +24820,7 @@
 	BUILDIN_DEF(getequipisenableref,"i?"),
 	BUILDIN_DEF(getequiprefinerycnt,"i?"),
 	BUILDIN_DEF(getequipweaponlv,"i?"),
-	BUILDIN_DEF(getequippercentrefinery,"i?"),
+	BUILDIN_DEF(getequippercentrefinery,"ii?"),
 	BUILDIN_DEF(successrefitem,"i??"),
 	BUILDIN_DEF(failedrefitem,"i?"),
 	BUILDIN_DEF(downrefitem,"i??"),
@@ -25291,8 +25336,11 @@
 	BUILDIN_DEF(achievementexists,"i?"),
 	BUILDIN_DEF(achievementupdate,"iii?"),
 
+	// Refine UI
+	BUILDIN_DEF(getequiprefinecost,"iii?"),
+	BUILDIN_DEF(getblacksmithblessing, "ii"),
+	BUILDIN_DEF(refineui,"?"),
 
-	BUILDIN_DEF(getequiprefinecost,"iii?"),
 	BUILDIN_DEF2(round, "round", "ii"),
 	BUILDIN_DEF2(round, "ceil", "ii"),
 	BUILDIN_DEF2(round, "floor", "ii"),
